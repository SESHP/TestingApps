# üß™ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

### 1. –û—á–∏—Å—Ç–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
```bash
cd backend
psql -d ton_guarantee -c "DELETE FROM referrals; DELETE FROM users;"
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend
```bash
npm run dev
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ frontend (–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
```bash
cd ..
npm start
```

## –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. **–ù–ï –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID: `999999999`
3. –í—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å "Test User"
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ABC12345`)
5. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–æ–¥–æ–º - —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ:**
```sql
SELECT telegram_id, first_name, referral_code, referred_by 
FROM users 
WHERE telegram_id = 999999999;
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–¥–æ–º.

## –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ

### –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ABC12345`)
2. –û—Ç–∫—Ä–æ–π—Ç–µ **–Ω–æ–≤–æ–µ –æ–∫–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ** (Cmd+Shift+N)
3. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000?ref=ABC12345`
4. –°–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "Invited User"

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö backend:**
```
üìå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: ABC12345
üîç –ü–æ–∏—Å–∫ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ —Å –∫–æ–¥–æ–º: ABC12345
‚úÖ –ù–∞–π–¥–µ–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä: { id: 999999999, name: 'Test User' }
üÜï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: [–Ω–æ–≤—ã–π_id]
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ:**
```sql
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT telegram_id, first_name, referral_code, referred_by FROM users;

-- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å 1 —Å–≤—è–∑—å
SELECT 
  r.*,
  u1.first_name as referrer_name,
  u2.first_name as referred_name
FROM referrals r
JOIN users u1 ON r.referrer_id = u1.telegram_id
JOIN users u2 ON r.referred_id = u2.telegram_id;
```

### –ß–µ—Ä–µ–∑ API

```bash
# 1. –ü–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl http://localhost:3001/api/user/init \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"initData":"dev"}' \
  | jq -r '.user.referralCode'

# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ABC12345)

# 2. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
curl http://localhost:3001/api/user/init \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"initData":"dev","referralCode":"ABC12345"}' \
  | jq

# –í –æ—Ç–≤–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
# - user.referredBy –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 999999999
# - referralStats.totalReferrals –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0
```

## –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

1. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ (–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
2. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
3. –í —Ä–∞–∑–¥–µ–ª–µ "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   - **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 1** (–∏–ª–∏ –±–æ–ª—å—à–µ)
   - **–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ TON: 0.00** (–ø–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API:**
```bash
curl http://localhost:3001/api/user/999999999/referrals | jq
```

–û—Ç–≤–µ—Ç:
```json
{
  "stats": {
    "totalReferrals": 1,
    "totalEarned": 0
  },
  "referrals": [
    {
      "telegramId": 123456,
      "username": "invited_...",
      "firstName": "Invited",
      "lastName": "User",
      "earnedAmount": 0,
      "createdAt": "2025-01-09T..."
    }
  ]
}
```

## –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –°—Ü–µ–Ω–∞—Ä–∏–π 2 –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å —Ä–∞–∑–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ.

**–í–∞–∂–Ω–æ:** –ö–∞–∂–¥—ã–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –∏–ª–∏ —Ä–∞–∑–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã!

–ü–æ—Å–ª–µ 3-—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—á–µ—Ç—á–∏–∫
curl http://localhost:3001/api/user/999999999/referrals | jq '.stats.totalReferrals'
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 3
```

## –°—Ü–µ–Ω–∞—Ä–∏–π 5: Debug endpoint

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É:

```bash
curl http://localhost:3001/api/debug/users | jq
```

–í—ã —É–≤–∏–¥–∏—Ç–µ:
- –í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
- –°—á–µ—Ç—á–∏–∫–∏

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

### ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:
- [ ] –ì–ª–∞–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç ID `999999999`
- [ ] –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä
- [ ] –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ `?ref=CODE` —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- [ ] –í –±–∞–∑–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- [ ] –ù–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è
- [ ] –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏

### ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–≥–æ –∂–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–∑ —Ç–æ–≥–æ –∂–µ –±—Ä–∞—É–∑–µ—Ä–∞
- [ ] –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫–æ–¥—É
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

## –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
DELETE FROM referrals;
DELETE FROM users WHERE telegram_id != 999999999;
```

### –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```sql
DELETE FROM referrals;
DELETE FROM users;
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã
```bash
psql -d ton_guarantee -f migrations/init.sql
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç

```bash
cd backend
npm run test-referral
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–æ–∑–¥–∞—Å—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
2. –°–æ–∑–¥–∞—Å—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–∞ —Å –∫–æ–¥–æ–º
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç —Å–≤—è–∑–∏
4. –ü–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

## Troubleshooting

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É: `SELECT * FROM referrals;`

### –°–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `server.js`
- –ì–ª–∞–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å ID `999999999`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `getTestUserData()`

### –†–µ—Ñ–µ—Ä–∞–ª –Ω–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –ó–ê–ì–õ–ê–í–ù–´–ú–ò –±—É–∫–≤–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "‚úÖ –ù–∞–π–¥–µ–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–µ—Ñ–µ—Ä–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ

### –û—à–∏–±–∫–∞ "duplicate key"
- –û—á–∏—Å—Ç–∏—Ç–µ –±–∞–∑—É: `DELETE FROM referrals; DELETE FROM users;`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ì–ª–∞–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** - –≤—Å–µ–≥–¥–∞ ID `999999999`, –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
2. **–†–µ—Ñ–µ—Ä–∞–ª—ã** - —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º ID –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ —Å `?ref=`
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** - –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
4. **–ò–Ω–∫–æ–≥–Ω–∏—Ç–æ** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. **–õ–æ–≥–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª backend